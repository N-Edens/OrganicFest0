@page "/SeFrivillige"
@using OrganicFest.Shared
@using OrganicFest.Client.Services
@inject Blazored.LocalStorage.ILocalStorageService localStore
@inject NavigationManager NavManager
@inject IBrugerService BrugerService

<PageTitle>Se Bruger</PageTitle>

<h1>Se Bruger</h1>

@if (visRedigeringsFormular)
{
<EditForm Model="@bruger" OnValidSubmit="ChangeBruger">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="col-md-12 mb-6">
        <label for="Navn">Navn</label>
        <InputText id="Navn" @bind-Value="bruger.Name" class="form-control"  />
    </div>
    <div class="col-md-12 mb-6">
        <label for="Email">Email</label>
        <InputText id="Email" @bind-Value="bruger.Email" class="form-control"  />
    </div>
    <div class="col-md-12 mb-6">
        <label for="Telefonnummer">Telefonnummer</label>
        <InputNumber class="form-input" @bind-Value="bruger.Telefonnummer" />
    </div>

    <div class="col-md-12 mb-6">
        <label for="IsCoordinator">Koordinator</label>
        <InputCheckbox id="IsCoordinator" @bind-Value="bruger.IsCoordinator" />
    </div>

    <button class="form-submit" type="submit">Gem</button>
</EditForm>
}

<table class="table">
    <thead>
        <tr>
            <th>FrivilligID</th>
            <th>Navn</th>
            <th>Email</th>
            <th>Telefonnummer</th>
            <th>Koordinator</th>
            <th>Password</th>
            <th>Handlinger</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var bruger in AlleBruger)
        {
            <tr>
                <td>@bruger.FID</td>
                <td>@bruger.Name</td>
                <td>@bruger.Email</td>
                <td>@bruger.Telefonnummer</td>
                <td>@bruger.IsCoordinator</td>
                <td>@bruger.Password</td>
                <td>
                    <button class="form-submit" @onclick="() => RedigerBruger(bruger)">Rediger Profil</button>
                    <button class="btn btn-danger btn-sm" @onclick="() => SletBruger(bruger.FID)">Slet</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    // Objekt for at lave Crud på Bruger
    private Bruger bruger = new Bruger();
    // Objekt af en liste som henter alle brugere se OnInitializedAsync
    private List<Bruger> AlleBruger = new List<Bruger>();
    // Boolean der gør det muligt at kunne redigere. Se RedigerBruger og ChangeBruger.
    private bool visRedigeringsFormular = false;

    protected override async Task OnInitializedAsync()
    {
        var currentUser = await localStore.GetItemAsync<Bruger>("loggedInUser");
        if (currentUser == null)
            NavManager.NavigateTo("/login");

        if (!currentUser.IsCoordinator)
        {
            NavManager.NavigateTo("/frivillig");
            return;
        }

        AlleBruger = (await BrugerService.GetAllBruger()).ToList();
    }

    // Her åbnes VisRedgeringsFormular og gør det muligt at redigere i den Bruger Profil
    // som er valgt udfra RedigerBruger knappen
    private void RedigerBruger(Bruger ValgteBruger)
    {
        bruger = ValgteBruger;
        visRedigeringsFormular = true;
    }

    // Her lukkes VisRedigeringsFormular og gemmer data i både LocalStorage og på Databasen
    private async Task ChangeBruger()
    {
        visRedigeringsFormular = false;
        await BrugerService.UpdateBruger(bruger);
    }

    private async Task SletBruger(int FID)
    {
        await BrugerService.DeleteBruger(FID);
        AlleBruger = (await BrugerService.GetAllBruger()).ToList();
    }
}
